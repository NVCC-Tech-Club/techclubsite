{"ast":null,"code":"import { __assign } from \"tslib\";\nimport { RRule } from './rrule';\nimport { RRuleSet } from './rruleset';\nimport { untilStringToDate } from './dateutil';\nimport { includes, split } from './helpers';\nimport { parseString, parseDtstart } from './parsestring';\n/**\n * RRuleStr\n * To parse a set of rrule strings\n */\nvar DEFAULT_OPTIONS = {\n  dtstart: null,\n  cache: false,\n  unfold: false,\n  forceset: false,\n  compatible: false,\n  tzid: null\n};\nexport function parseInput(s, options) {\n  var rrulevals = [];\n  var rdatevals = [];\n  var exrulevals = [];\n  var exdatevals = [];\n  var parsedDtstart = parseDtstart(s);\n  var dtstart = parsedDtstart.dtstart;\n  var tzid = parsedDtstart.tzid;\n  var lines = splitIntoLines(s, options.unfold);\n  lines.forEach(function (line) {\n    var _a;\n    if (!line) return;\n    var _b = breakDownLine(line),\n      name = _b.name,\n      parms = _b.parms,\n      value = _b.value;\n    switch (name.toUpperCase()) {\n      case 'RRULE':\n        if (parms.length) {\n          throw new Error(\"unsupported RRULE parm: \".concat(parms.join(',')));\n        }\n        rrulevals.push(parseString(line));\n        break;\n      case 'RDATE':\n        var _c = (_a = /RDATE(?:;TZID=([^:=]+))?/i.exec(line)) !== null && _a !== void 0 ? _a : [],\n          rdateTzid = _c[1];\n        if (rdateTzid && !tzid) {\n          tzid = rdateTzid;\n        }\n        rdatevals = rdatevals.concat(parseRDate(value, parms));\n        break;\n      case 'EXRULE':\n        if (parms.length) {\n          throw new Error(\"unsupported EXRULE parm: \".concat(parms.join(',')));\n        }\n        exrulevals.push(parseString(value));\n        break;\n      case 'EXDATE':\n        exdatevals = exdatevals.concat(parseRDate(value, parms));\n        break;\n      case 'DTSTART':\n        break;\n      default:\n        throw new Error('unsupported property: ' + name);\n    }\n  });\n  return {\n    dtstart: dtstart,\n    tzid: tzid,\n    rrulevals: rrulevals,\n    rdatevals: rdatevals,\n    exrulevals: exrulevals,\n    exdatevals: exdatevals\n  };\n}\nfunction buildRule(s, options) {\n  var _a = parseInput(s, options),\n    rrulevals = _a.rrulevals,\n    rdatevals = _a.rdatevals,\n    exrulevals = _a.exrulevals,\n    exdatevals = _a.exdatevals,\n    dtstart = _a.dtstart,\n    tzid = _a.tzid;\n  var noCache = options.cache === false;\n  if (options.compatible) {\n    options.forceset = true;\n    options.unfold = true;\n  }\n  if (options.forceset || rrulevals.length > 1 || rdatevals.length || exrulevals.length || exdatevals.length) {\n    var rset_1 = new RRuleSet(noCache);\n    rset_1.dtstart(dtstart);\n    rset_1.tzid(tzid || undefined);\n    rrulevals.forEach(function (val) {\n      rset_1.rrule(new RRule(groomRruleOptions(val, dtstart, tzid), noCache));\n    });\n    rdatevals.forEach(function (date) {\n      rset_1.rdate(date);\n    });\n    exrulevals.forEach(function (val) {\n      rset_1.exrule(new RRule(groomRruleOptions(val, dtstart, tzid), noCache));\n    });\n    exdatevals.forEach(function (date) {\n      rset_1.exdate(date);\n    });\n    if (options.compatible && options.dtstart) rset_1.rdate(dtstart);\n    return rset_1;\n  }\n  var val = rrulevals[0] || {};\n  return new RRule(groomRruleOptions(val, val.dtstart || options.dtstart || dtstart, val.tzid || options.tzid || tzid), noCache);\n}\nexport function rrulestr(s, options) {\n  if (options === void 0) {\n    options = {};\n  }\n  return buildRule(s, initializeOptions(options));\n}\nfunction groomRruleOptions(val, dtstart, tzid) {\n  return __assign(__assign({}, val), {\n    dtstart: dtstart,\n    tzid: tzid\n  });\n}\nfunction initializeOptions(options) {\n  var invalid = [];\n  var keys = Object.keys(options);\n  var defaultKeys = Object.keys(DEFAULT_OPTIONS);\n  keys.forEach(function (key) {\n    if (!includes(defaultKeys, key)) invalid.push(key);\n  });\n  if (invalid.length) {\n    throw new Error('Invalid options: ' + invalid.join(', '));\n  }\n  return __assign(__assign({}, DEFAULT_OPTIONS), options);\n}\nfunction extractName(line) {\n  if (line.indexOf(':') === -1) {\n    return {\n      name: 'RRULE',\n      value: line\n    };\n  }\n  var _a = split(line, ':', 1),\n    name = _a[0],\n    value = _a[1];\n  return {\n    name: name,\n    value: value\n  };\n}\nfunction breakDownLine(line) {\n  var _a = extractName(line),\n    name = _a.name,\n    value = _a.value;\n  var parms = name.split(';');\n  if (!parms) throw new Error('empty property name');\n  return {\n    name: parms[0].toUpperCase(),\n    parms: parms.slice(1),\n    value: value\n  };\n}\nfunction splitIntoLines(s, unfold) {\n  if (unfold === void 0) {\n    unfold = false;\n  }\n  s = s && s.trim();\n  if (!s) throw new Error('Invalid empty string');\n  // More info about 'unfold' option\n  // Go head to http://www.ietf.org/rfc/rfc2445.txt\n  if (!unfold) {\n    return s.split(/\\s/);\n  }\n  var lines = s.split('\\n');\n  var i = 0;\n  while (i < lines.length) {\n    // TODO\n    var line = lines[i] = lines[i].replace(/\\s+$/g, '');\n    if (!line) {\n      lines.splice(i, 1);\n    } else if (i > 0 && line[0] === ' ') {\n      lines[i - 1] += line.slice(1);\n      lines.splice(i, 1);\n    } else {\n      i += 1;\n    }\n  }\n  return lines;\n}\nfunction validateDateParm(parms) {\n  parms.forEach(function (parm) {\n    if (!/(VALUE=DATE(-TIME)?)|(TZID=)/.test(parm)) {\n      throw new Error('unsupported RDATE/EXDATE parm: ' + parm);\n    }\n  });\n}\nfunction parseRDate(rdateval, parms) {\n  validateDateParm(parms);\n  return rdateval.split(',').map(function (datestr) {\n    return untilStringToDate(datestr);\n  });\n}","map":{"version":3,"names":["RRule","RRuleSet","untilStringToDate","includes","split","parseString","parseDtstart","DEFAULT_OPTIONS","dtstart","cache","unfold","forceset","compatible","tzid","parseInput","s","options","rrulevals","rdatevals","exrulevals","exdatevals","parsedDtstart","lines","splitIntoLines","forEach","line","_b","breakDownLine","name","parms","value","toUpperCase","length","Error","concat","join","push","_c","_a","exec","rdateTzid","parseRDate","buildRule","noCache","rset_1","undefined","val","rrule","groomRruleOptions","date","rdate","exrule","exdate","rrulestr","initializeOptions","__assign","invalid","keys","Object","defaultKeys","key","extractName","indexOf","slice","trim","i","replace","splice","validateDateParm","parm","test","rdateval","map","datestr"],"sources":["../../src/rrulestr.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}